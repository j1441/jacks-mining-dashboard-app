name: Build, Push and Update App Store

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.1)'
        required: false
        type: string

env:
  DOCKER_HUB_USERNAME: j73642
  IMAGE_NAME: mining-dashboard-app
  APP_STORE_REPO: j1441/Jack-s-Community-Store
  APP_FOLDER: jacks-mining-dashboard

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.version }}" ]]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            # Use short SHA for non-tagged commits
            echo "version=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image info
        run: |
          echo "## Docker Image Published ðŸ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Full image reference for docker-compose.yml:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}@${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  update-app-store:
    needs: build-and-push
    runs-on: ubuntu-latest
    # Only run on main branch pushes or tags, not PRs
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout app store repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.APP_STORE_REPO }}
          token: ${{ secrets.APP_STORE_PAT }}
          path: app-store

      - name: Update docker-compose.yml with new image
        run: |
          cd app-store/${{ env.APP_FOLDER }}
          
          # New image reference with digest
          NEW_IMAGE="${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}@${{ needs.build-and-push.outputs.digest }}"
          
          echo "Updating image to: $NEW_IMAGE"
          
          # Update the image line in docker-compose.yml
          # This handles various formats: image: user/repo:tag or image: user/repo:tag@sha256:...
          sed -i "s|image:.*${{ env.IMAGE_NAME }}.*|image: $NEW_IMAGE|g" docker-compose.yml
          
          echo "Updated docker-compose.yml:"
          cat docker-compose.yml

      - name: Update umbrel-app.yml version
        run: |
          cd app-store/${{ env.APP_FOLDER }}
          
          VERSION="${{ needs.build-and-push.outputs.version }}"
          
          # Only update version if it looks like a semantic version
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            # Update the version field
            sed -i "s/^version:.*/version: \"$VERSION\"/" umbrel-app.yml
            echo "Updated umbrel-app.yml version to: $VERSION"
          else
            echo "Skipping version update (not a semantic version): $VERSION"
          fi

      - name: Commit and push changes
        run: |
          cd app-store
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update ${{ env.APP_FOLDER }} to version ${{ needs.build-and-push.outputs.version }}

          Image: ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}
          Digest: ${{ needs.build-and-push.outputs.digest }}
          
          Automated update from: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            git push
            echo "âœ… App store updated successfully!" >> $GITHUB_STEP_SUMMARY
          fi
